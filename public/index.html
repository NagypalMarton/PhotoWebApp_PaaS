<!doctype html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PhotoWebApp MVP</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f5f5f5;
        color: #222;
      }
      .container {
        max-width: 960px;
        margin: 24px auto;
        background: white;
        padding: 16px;
        border-radius: 8px;
      }
      h1 {
        margin-top: 0;
      }
      form {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
      }
      input, button, select {
        padding: 8px;
      }
      .layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .list {
        border: 1px solid #ddd;
        border-radius: 6px;
        overflow: hidden;
      }
      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .row:last-child {
        border-bottom: none;
      }
      .meta {
        cursor: pointer;
        flex: 1;
      }
      .preview {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        min-height: 280px;
      }
      img {
        max-width: 100%;
        max-height: 420px;
        display: block;
      }
      .muted {
        color: #666;
      }
      .toolbar {
        margin-bottom: 12px;
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .pager {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 12px;
      }
      @media (max-width: 860px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>PhotoWebApp – Minimál MVP</h1>

      <form id="uploadForm">
        <input id="name" type="text" maxlength="40" placeholder="Kép neve (max 40 karakter)" required />
        <input id="tags" type="text" placeholder="Címkék (opcionális, pl: nyár, utazás)" />
        <input id="photo" type="file" accept="image/*" required />
        <button type="submit">Feltöltés</button>
      </form>

      <div class="toolbar">
        <label for="search">Keresés:</label>
        <input id="search" type="text" placeholder="Képnév alapján" />
        <label for="sort">Rendezés:</label>
        <select id="sort">
          <option value="date-desc">Dátum (új → régi)</option>
          <option value="date-asc">Dátum (régi → új)</option>
          <option value="name-asc">Név (A-Z)</option>
          <option value="name-desc">Név (Z-A)</option>
        </select>
        <span id="message" class="muted"></span>
      </div>

      <div class="layout">
        <div class="list" id="photoList"></div>
        <div class="preview">
          <h3>Előnézet</h3>
          <div id="previewContent" class="muted">Válassz ki egy képet a listából.</div>
        </div>
      </div>
      <div class="pager">
        <button id="prevPage" type="button">Előző</button>
        <span id="pageInfo" class="muted">1 / 1</span>
        <button id="nextPage" type="button">Következő</button>
      </div>
    </div>

    <script>
      const uploadForm = document.getElementById('uploadForm');
      const nameInput = document.getElementById('name');
      const tagsInput = document.getElementById('tags');
      const fileInput = document.getElementById('photo');
      const sortInput = document.getElementById('sort');
      const searchInput = document.getElementById('search');
      const listEl = document.getElementById('photoList');
      const previewEl = document.getElementById('previewContent');
      const messageEl = document.getElementById('message');
      const prevPageButton = document.getElementById('prevPage');
      const nextPageButton = document.getElementById('nextPage');
      const pageInfoEl = document.getElementById('pageInfo');

      let photos = [];
      let currentPage = 1;
      let totalPages = 1;
      const pageSize = 8;

      function formatDate(dateString) {
        const d = new Date(dateString);
        if (Number.isNaN(d.getTime())) {
          return dateString;
        }
        return d.toLocaleString('hu-HU', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      function setMessage(text) {
        messageEl.textContent = text;
      }

      function renderList() {
        if (photos.length === 0) {
          listEl.innerHTML = '<div class="row"><span class="muted">Nincs feltöltött kép.</span></div>';
          return;
        }

        listEl.innerHTML = '';
        photos.forEach((p) => {
          const row = document.createElement('div');
          row.className = 'row';

          const meta = document.createElement('div');
          meta.className = 'meta';
          const tagsText = p.tags && p.tags.length > 0 ? `<br><span class="muted">Címkék: ${p.tags.join(', ')}</span>` : '';
          meta.innerHTML = `<strong>${p.name}</strong><br><span class="muted">${formatDate(p.upload_datetime)}</span>${tagsText}`;
          meta.addEventListener('click', () => {
            const previewTags = p.tags && p.tags.length > 0 ? `<br><span class="muted">Címkék: ${p.tags.join(', ')}</span>` : '';
            previewEl.innerHTML = `<strong>${p.name}</strong>${previewTags}<br><br><img src="${p.image_url}" alt="${p.name}" />`;
          });

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Törlés';
          deleteBtn.addEventListener('click', async () => {
            const response = await fetch(`/api/photos/${p.id}`, { method: 'DELETE' });
            if (!response.ok) {
              setMessage('Törlés közben hiba történt.');
              return;
            }
            setMessage('Kép törölve.');
            await loadPhotos();
          });

          row.appendChild(meta);
          row.appendChild(deleteBtn);
          listEl.appendChild(row);
        });
      }

      async function loadPhotos() {
        const [sort, order] = sortInput.value.split('-');
        const search = encodeURIComponent(searchInput.value.trim());
        const response = await fetch(`/api/photos?sort=${sort}&order=${order}&search=${search}&page=${currentPage}&pageSize=${pageSize}`);
        if (!response.ok) {
          setMessage('A lista betöltése sikertelen.');
          return;
        }
        const data = await response.json();
        photos = data.items || [];
        const total = Number(data.total || 0);
        totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) {
          currentPage = totalPages;
          await loadPhotos();
          return;
        }
        pageInfoEl.textContent = `${currentPage} / ${totalPages}`;
        prevPageButton.disabled = currentPage <= 1;
        nextPageButton.disabled = currentPage >= totalPages;
        renderList();
      }

      uploadForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        setMessage('Feltöltés...');

        const name = nameInput.value.trim();
        if (!name || name.length > 40) {
          setMessage('A név kötelező és max. 40 karakter.');
          return;
        }

        if (!fileInput.files.length) {
          setMessage('Válassz képfájlt.');
          return;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('tags', tagsInput.value.trim());
        formData.append('photo', fileInput.files[0]);

        const response = await fetch('/api/photos', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ message: 'Ismeretlen hiba.' }));
          setMessage(error.message || 'Feltöltési hiba.');
          return;
        }

        uploadForm.reset();
        setMessage('Sikeres feltöltés.');
        currentPage = 1;
        await loadPhotos();
      });

      sortInput.addEventListener('change', () => {
        currentPage = 1;
        loadPhotos();
      });

      searchInput.addEventListener('input', () => {
        currentPage = 1;
        loadPhotos();
      });

      prevPageButton.addEventListener('click', async () => {
        if (currentPage > 1) {
          currentPage -= 1;
          await loadPhotos();
        }
      });

      nextPageButton.addEventListener('click', async () => {
        if (currentPage < totalPages) {
          currentPage += 1;
          await loadPhotos();
        }
      });

      loadPhotos();
    </script>
  </body>
</html>
